@page "/institutions"
@rendermode InteractiveServer
@inject HttpClient Http

<PageTitle>Instituciones - DermaUH</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Instituciones</h2>
    <button class="btn btn-success" @onclick="() => showForm = !showForm">
        @(showForm ? "Cancelar" : "+ Nueva Institución")
    </button>
</div>

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Registrar Institución</h5>
            <EditForm Model="newInstitution" OnValidSubmit="HandleCreate" FormName="createInstitution">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <InputText @bind-Value="newInstitution.Name" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">País</label>
                            <InputText @bind-Value="newInstitution.Country" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ciudad</label>
                            <InputText @bind-Value="newInstitution.City" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <InputText @bind-Value="newInstitution.Address" class="form-control" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <InputTextArea @bind-Value="newInstitution.Description" class="form-control" rows="3" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Website</label>
                            <InputText @bind-Value="newInstitution.Website" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email de Contacto</label>
                            <InputText @bind-Value="newInstitution.ContactEmail" class="form-control" />
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" disabled="@submitting">
                    @(submitting ? "Guardando..." : "Guardar")
                </button>
            </EditForm>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (loading)
{
    <p><em>Cargando...</em></p>
}
else if (response is null || !response.Items.Any())
{
    <div class="alert alert-info">No se encontraron instituciones.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>País</th>
                    <th>Ciudad</th>
                    <th>Email</th>
                    <th>Website</th>
                    <th>Fecha de Registro</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var inst in response.Items)
                {
                    <tr>
                        <td><strong>@inst.Name</strong></td>
                        <td>@(inst.Country ?? "—")</td>
                        <td>@(inst.City ?? "—")</td>
                        <td>@(inst.ContactEmail ?? "—")</td>
                        <td>
                            @if (!string.IsNullOrEmpty(inst.Website))
                            {
                                <a href="@inst.Website" target="_blank">@inst.Website</a>
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </td>
                        <td>@inst.CreatedAt.ToString("yyyy-MM-dd")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private PagedResponse<InstitutionDto>? response;
    private bool loading = true;
    private bool showForm = false;
    private bool submitting = false;
    private string? errorMessage;
    private InstitutionFormModel newInstitution = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            response = await Http.GetFromJsonAsync<PagedResponse<InstitutionDto>>("api/institutions?page=1&pageSize=50");
        }
        catch
        {
            response = null;
        }
        loading = false;
    }

    private async Task HandleCreate()
    {
        submitting = true;
        errorMessage = null;
        try
        {
            var result = await Http.PostAsJsonAsync("api/institutions", new
            {
                newInstitution.Name,
                newInstitution.Description,
                newInstitution.Country,
                newInstitution.City,
                newInstitution.Address,
                newInstitution.Website,
                newInstitution.ContactEmail
            });

            if (result.IsSuccessStatusCode)
            {
                newInstitution = new();
                showForm = false;
                await LoadData();
            }
            else
            {
                errorMessage = $"Error: {result.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            submitting = false;
        }
    }

    private class InstitutionFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? Country { get; set; }
        public string? City { get; set; }
        public string? Address { get; set; }
        public string? Website { get; set; }
        public string? ContactEmail { get; set; }
    }
}
