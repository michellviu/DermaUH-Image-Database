@page "/users"
@rendermode InteractiveServer
@inject HttpClient Http

<PageTitle>Usuarios - DermaUH</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Usuarios</h2>
    <button class="btn btn-success" @onclick="() => showForm = !showForm">
        @(showForm ? "Cancelar" : "+ Nuevo Usuario")
    </button>
</div>

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Registrar Usuario</h5>
            <EditForm Model="newUser" OnValidSubmit="HandleCreate" FormName="createUser">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <InputText @bind-Value="newUser.FirstName" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Apellido *</label>
                            <InputText @bind-Value="newUser.LastName" class="form-control" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <InputText @bind-Value="newUser.Email" class="form-control" type="email" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contrase√±a *</label>
                            <InputText @bind-Value="newUser.Password" class="form-control" type="password" />
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" disabled="@submitting">
                    @(submitting ? "Guardando..." : "Guardar")
                </button>
            </EditForm>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (loading)
{
    <p><em>Cargando...</em></p>
}
else if (response is null || !response.Items.Any())
{
    <div class="alert alert-info">No se encontraron usuarios.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Fecha de Registro</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in response.Items)
                {
                    <tr>
                        <td><strong>@user.FirstName @user.LastName</strong></td>
                        <td>@user.Email</td>
                        <td><span class="badge bg-info">@user.Role</span></td>
                        <td>
                            @if (user.IsActive)
                            {
                                <span class="badge bg-success">Activo</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactivo</span>
                            }
                        </td>
                        <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private PagedResponse<UserDto>? response;
    private bool loading = true;
    private bool showForm = false;
    private bool submitting = false;
    private string? errorMessage;
    private UserFormModel newUser = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            response = await Http.GetFromJsonAsync<PagedResponse<UserDto>>("api/users?page=1&pageSize=50");
        }
        catch
        {
            response = null;
        }
        loading = false;
    }

    private async Task HandleCreate()
    {
        submitting = true;
        errorMessage = null;
        try
        {
            var result = await Http.PostAsJsonAsync("api/users", new
            {
                newUser.FirstName,
                newUser.LastName,
                newUser.Email,
                newUser.Password
            });

            if (result.IsSuccessStatusCode)
            {
                newUser = new();
                showForm = false;
                await LoadData();
            }
            else
            {
                errorMessage = $"Error: {result.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            submitting = false;
        }
    }

    private class UserFormModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
